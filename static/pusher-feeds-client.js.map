{"version":3,"file":"pusher-feeds-client.js","sources":["../src/main.js"],"sourcesContent":["const defaultHost = \"api-ceres.kube.pusherplatform.io\";\nconst defaultAuthEndpoint = \"/feeds/tokens\";\nconst feedIdRegex = /^[a-zA-Z0-9-]+$/;\nconst heartbeatInterval = 30;\n\nfunction feedUrl(host, appId, feedId, tailSize) {\n  const query = tailSize ? `?tail_size=${tailSize}` : \"\";\n  return `https://${host}/apps/${appId}/services/feeds/v1/feeds/${feedId}/items${query}`;\n}\n\nfunction authUrl(authEndpoint, feedId) {\n  return `${authEndpoint}?feed_id=${feedId}&type=READ`;\n}\n\nclass EventHandler {\n  constructor(onEvent, request) {\n    this.head = 0;\n    this.onEvent = onEvent;\n    request.onreadystatechange = () => {\n      if (request.readyState > 2) {\n        this.process(request.responseText);\n      }\n    };\n  }\n\n  processSlice(slice) {\n    slice.split(\"\\n\").forEach(line => {\n      const event = JSON.parse(line);\n      if (event[0] === 0) {\n        // ignore?\n      } else if (event[0] === 1) {\n        this.lastEventId = event[1];\n        this.onEvent({ itemId: event[1], ...event[3] });\n      } else if (event[0] === 225) {\n        console.warn(\"End of stream\"); // do something!\n      } else {\n        console.warn(`Unknown event type: ${event[0]}`);\n      }\n    });\n  }\n\n  process(raw) {\n    const lastNewLine = raw.lastIndexOf(\"\\n\");\n    if (lastNewLine <= this.head) {\n      return;\n    }\n    this.processSlice(raw.slice(this.head, lastNewLine));\n    this.head = lastNewLine + 1;\n  }\n}\n\nfunction makeAuthRequest(authEndpoint, feedId) {\n  return new Promise((resolve, reject) => {\n    const xhr = new XMLHttpRequest();\n    xhr.open(\"GET\", authUrl(authEndpoint, feedId));\n    xhr.addEventListener(\"load\", () => {\n      if (xhr.status === 200) {\n        resolve(JSON.parse(xhr.responseText).token);\n      } else {\n        reject(new Error(`Couldn't get token from ${authEndpoint}; got ${xhr.status} ${xhr.statusText}.`));\n      }\n    });\n    xhr.send();\n  })\n}\n\nfunction authorize(feedId, authEndpoint) {\n  if (feedId.startsWith(\"private-\")) {\n    return makeAuthRequest(authEndpoint, feedId);\n  }\n  return Promise.resolve(null);\n}\n\nclass Subscription {\n  constructor(feedId, {\n    appId,\n    authEndpoint,\n    host,\n    lastEventId,\n    onEvent,\n    tailSize,\n    token\n  }) {\n    this.request = new XMLHttpRequest()\n    this.request.open(\"SUBSCRIBE\", feedUrl(host, appId, feedId, tailSize));\n    this.eventHandler = new EventHandler(onEvent, this.request);\n    this.request.onreadystatechange = () => {\n      if (this.request.readyState > 2) {\n        this.eventHandler.process(this.request.responseText);\n      }\n    };\n    if (lastEventId) {\n      this.request.setRequestHeader(\"Last-Event-ID\", lastEventId);\n    }\n    if (!feedId.match(feedIdRegex)) {\n      throw new TypeError(`feed_id must match regex ${feedIdRegex}`);\n    }\n    authorize(feedId, authEndpoint).then(token => {\n      if (token) {\n        this.request.setRequestHeader(\"Authorization\", `Bearer ${token}`);\n      }\n      this.request.send();\n    }).catch(e => {\n      console.warn(e.message);\n    });\n  }\n\n  close() {\n    this.request.abort();\n  }\n\n  get lastEventId() {\n    return this.eventHandler.lastEventId;\n  }\n}\n\nclass PusherFeeds {\n  constructor({ appId, host, authEndpoint }) {\n    this.host = host || defaultHost;\n    this.appId = appId;\n    this.authEndpoint = authEndpoint || defaultAuthEndpoint;\n  }\n\n  subscribe(feedId, options) {\n    if (!options) {\n      options = {};\n    }\n    return new Subscription(feedId, { ...this, ...options });\n  }\n}\n\nexport default PusherFeeds;\n"],"names":["defaultHost","defaultAuthEndpoint","feedIdRegex","feedUrl","host","appId","feedId","tailSize","query","authUrl","authEndpoint","EventHandler","onEvent","request","head","onreadystatechange","readyState","process","responseText","slice","split","forEach","event","JSON","parse","line","lastEventId","itemId","warn","raw","lastNewLine","lastIndexOf","processSlice","makeAuthRequest","Promise","resolve","reject","xhr","XMLHttpRequest","open","addEventListener","status","token","Error","statusText","send","authorize","startsWith","Subscription","eventHandler","setRequestHeader","match","TypeError","then","catch","e","message","abort","PusherFeeds","options"],"mappings":"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"}